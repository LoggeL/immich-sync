{% extends "base.html" %}
{% block content %}
<div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
  <div class="lg:col-span-1">
    <div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
      <h2 class="mb-4 text-lg font-semibold">Create Sync Group</h2>
      <form method="post" action="/groups" class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-gray-700">Name</label>
          <input class="mt-1 w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" type="text" name="name" placeholder="My Shared Album" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Daily Time (HH:MM)</label>
          <input class="mt-1 w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" type="text" name="schedule_time" value="02:00" />
        </div>
        <button class="inline-flex items-center rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500" type="submit">Create</button>
      </form>
    </div>
  </div>

  <div class="lg:col-span-2">
    <div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
      <div class="mb-4 flex items-center justify-between">
        <h2 class="text-lg font-semibold">Groups</h2>
      </div>
      {% if groups %}
        <div class="-mx-6 -my-6 overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Name</th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Code</th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Instances</th>
                <th class="px-6 py-3"></th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 bg-white">
            {% for g in groups %}
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4">
                  <div class="font-medium">{{ g.name or 'Sync' }}</div>
                  <div class="mt-1 text-xs text-gray-500">Progress</div>
                  <div class="mt-1 h-2 w-48 overflow-hidden rounded bg-gray-100">
                    <div id="group-progress-{{ g.id }}" class="h-2 bg-indigo-600" data-coverage="{{ coverage.get(g.id, 0) }}" style="width: {{ coverage.get(g.id, 0) }}%"></div>
                  </div>
                </td>
                <td class="px-6 py-4"><code class="rounded bg-gray-100 px-1 py-0.5 text-xs">{{ g.code }}</code></td>
                <td class="px-6 py-4">{{ instance_counts.get(g.id, 0) }}</td>
                <td class="px-6 py-4 text-right">
                  <a href="/groups/{{ g.id }}" class="text-indigo-600 hover:text-indigo-900">Open</a>
                  <form method="post" action="/groups/{{ g.id }}/delete" class="inline ml-3" onsubmit="return confirm('Delete this group?')">
                    <button class="text-red-600 hover:text-red-800" type="submit">Delete</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="rounded-md border border-dashed border-gray-300 p-8 text-center text-gray-500">No groups yet. Create one on the left.</div>
      {% endif %}
    </div>
  </div>
</div>
<script>
async function pollAllProgress() {
  try {
    const rows = document.querySelectorAll('[id^="group-progress-"]');
    for (const bar of rows) {
      const id = bar.id.replace('group-progress-','');
      const res = await fetch(`/api/groups/${id}/progress`);
      const data = await res.json();
      const total = data.total || 0;
      const done = data.done || 0;
      let pct = 0;
      if (data.status === 'running' && total > 0) {
        pct = Math.round((done/total)*100);
      } else {
        const cov = parseInt(bar.getAttribute('data-coverage') || '0', 10);
        pct = isNaN(cov) ? 0 : cov;
      }
      bar.style.width = pct + '%';
    }
  } catch (e) { /* ignore */ }
}
setInterval(pollAllProgress, 1500);
pollAllProgress();
</script>
{% endblock %}

